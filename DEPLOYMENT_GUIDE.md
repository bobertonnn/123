
# Руководство по развертыванию на выделенном сервере

Это руководство поможет вам развернуть ваше Next.js приложение на выделенном сервере.

## 1. Предварительные требования

Убедитесь, что на вашем сервере установлены:
- **Node.js**: Рекомендуется последняя LTS-версия. Вы можете установить его с помощью `nvm` (Node Version Manager) для удобства управления версиями.
- **npm** (обычно поставляется с Node.js) или **yarn**.
- **Git** (для клонирования репозитория).
- (Опционально, но рекомендуется) **Docker** и **Docker Compose**, если вы планируете использовать контейнеризацию.
- (Опционально, но рекомендуется) **MySQL сервер**, если вы переходите на него с `localStorage`.

## 2. Подготовка проекта на сервере

1.  **Клонируйте ваш репозиторий** (или скопируйте файлы проекта) на сервер:
    ```bash
    git clone <your-repository-url>
    cd <your-project-directory>
    ```

2.  **Установите зависимости:**
    ```bash
    npm install
    # или
    # yarn install
    ```

## 3. Переменные окружения

Вашему приложению для корректной работы (например, для Firebase, подключения к MySQL, Genkit, Telegram) потребуются переменные окружения.

- В корне вашего проекта на сервере создайте файл `.env.production` из примера `db_schema/mysql/.env.production.example`:
  ```bash
  cp db_schema/mysql/.env.production.example .env.production
  ```
- Откройте `.env.production` в текстовом редакторе (например, `nano .env.production`) и **заполните все необходимые значения** вашими реальными данными (API ключи, данные для подключения к БД и т.д.).
- **Важно:** Никогда не добавляйте файл `.env.production` с реальными секретами в систему контроля версий (git). Убедитесь, что `.env.production` добавлен в ваш файл `.gitignore`.
- Next.js автоматически загрузит переменные из `.env.production` при сборке и запуске в продакшен-режиме.

## 4. База данных MySQL (если используется)

1.  **Установите и настройте MySQL сервер** на вашем выделенном сервере.
2.  **Создайте базу данных** и пользователя для вашего приложения.
3.  **Примените SQL-схемы**, предоставленные в папке `db_schema/mysql/`. Вы можете выполнить их, например, через MySQL CLI:
    ```bash
    mysql -u your_mysql_user -p your_database_name < db_schema/mysql/01_users.sql
    mysql -u your_mysql_user -p your_database_name < db_schema/mysql/02_contacts.sql
    mysql -u your_mysql_user -p your_database_name < db_schema/mysql/03_notifications.sql
    mysql -u your_mysql_user -p your_database_name < db_schema/mysql/04_documents.sql
    ```
4.  **Разработайте API эндпоинты** в вашем Next.js приложении для взаимодействия с этой базой данных и **обновите клиентскую логику** (например, в `src/lib/contactManager.ts`, `src/lib/notificationManager.ts`, `src/app/(app)/dashboard/page.tsx` и `src/components/documents/PdfUploader.tsx`) для использования этих API вместо `localStorage`. (См. комментарии-заглушки `TODO: [DB Integration]` в этих файлах).
    *   *Примечание о `documents.dataUrl`*: Хранение больших файлов (как PDF в base64) напрямую в базе данных (например, в поле `LONGTEXT`) не всегда является оптимальным решением из-за производительности и размера БД. Рассмотрите возможность хранения файлов в выделенном хранилище (Firebase Storage, AWS S3, или на файловой системе сервера) и сохранения в базе данных только пути или URL к файлу.

## 5. Сборка приложения

Соберите ваше приложение для продакшена:
```bash
npm run build
```
Эта команда создаст оптимизированную сборку в папке `.next`. По умолчанию, карты кода (source maps) для клиентского бандла не будут генерироваться для продакшен сборки (`productionBrowserSourceMaps: false` в `next.config.js`), что является базовой мерой защиты от простого реверс-инжиниринга.

## 6. Запуск приложения

Для запуска продакшен-сервера используйте:
```bash
npm run start
```
По умолчанию Next.js запустится на порту 3000. Вы можете изменить порт, указав его при запуске: `npm run start -- -p <your_port_number>`.

## 7. Менеджер процессов (PM2)

Чтобы ваше приложение работало в фоновом режиме, автоматически перезапускалось при сбоях и после перезагрузки сервера, рекомендуется использовать менеджер процессов, такой как PM2.

1.  **Установите PM2 глобально (если еще не установлен):**
    ```bash
    npm install pm2 -g
    ```

2.  **Настройте PM2 для вашего приложения.** Вы можете использовать пример `ecosystem.config.js.example`. Скопируйте его в `ecosystem.config.js` и настройте:
    ```bash
    cp ecosystem.config.js.example ecosystem.config.js
    # Отредактируйте ecosystem.config.js (например, имя приложения, порт)
    ```
    Запустите приложение с помощью PM2, указав окружение `production`:
    ```bash
    pm2 start ecosystem.config.js --env production
    ```

3.  **Основные команды PM2:**
    -   `pm2 list`: Показать список всех запущенных приложений.
    -   `pm2 stop <app_name_or_id>`: Остановить приложение.
    -   `pm2 restart <app_name_or_id>`: Перезапустить приложение.
    -   `pm2 logs <app_name_or_id>`: Показать логи приложения.
    -   `pm2 startup`: Настроить PM2 для автоматического запуска ваших приложений при загрузке системы.
    -   `pm2 save`: Сохранить текущий список процессов PM2.

## 8. Обратный прокси (Nginx)

Настоятельно рекомендуется использовать веб-сервер, такой как Nginx, в качестве обратного прокси. Nginx будет принимать HTTP/HTTPS запросы и перенаправлять их на ваше Next.js приложение.

1.  **Установите Nginx:**
    ```bash
    sudo apt update
    sudo apt install nginx
    ```

2.  **Настройте Nginx для вашего сайта.** Создайте новый файл конфигурации для вашего сайта в `/etc/nginx/sites-available/`. Вы можете использовать пример `nginx.conf.example` как основу. Замените `your-domain.com` на ваш домен, `/path/to/your-project-directory/` на реальный путь и `3000` на порт вашего Next.js приложения.
    ```bash
    sudo nano /etc/nginx/sites-available/your-domain.com
    ```
    Скопируйте и адаптируйте содержимое из `nginx.conf.example`.

3.  **Создайте символическую ссылку на ваш файл конфигурации в `sites-enabled`:**
    ```bash
    sudo ln -s /etc/nginx/sites-available/your-domain.com /etc/nginx/sites-enabled/
    ```

4.  **Проверьте конфигурацию Nginx на ошибки:**
    ```bash
    sudo nginx -t
    ```

5.  **Перезапустите Nginx, чтобы применить изменения:**
    ```bash
    sudo systemctl restart nginx
    ```
    Nginx конфигурация в `nginx.conf.example` включает меры по предотвращению прямого листинга директорий.

6.  **Настройка HTTPS (SSL с Let's Encrypt):**
    Рекомендуется использовать Certbot для автоматической настройки SSL.
    ```bash
    sudo apt install certbot python3-certbot-nginx
    sudo certbot --nginx -d your-domain.com -d www.your-domain.com
    ```
    Certbot автоматически изменит вашу конфигурацию Nginx для использования HTTPS.

## 9. Брандмауэр

Убедитесь, что ваш брандмауэр (например, `ufw`) настроен на разрешение трафика на порты 80 (HTTP) и 443 (HTTPS).
```bash
sudo ufw allow 'Nginx Full' # или 'Nginx HTTP' и 'Nginx HTTPS' отдельно
sudo ufw enable
sudo ufw status
```

## 10. Docker (Опционально)

Если вы предпочитаете использовать Docker для развертывания:
1.  Убедитесь, что Docker установлен на вашем сервере.
2.  Используйте предоставленный `Dockerfile` для сборки образа вашего приложения:
    ```bash
    # Пример передачи build-time переменных (если они у вас есть в Dockerfile)
    # docker build --build-arg NEXT_PUBLIC_FIREBASE_API_KEY=your_api_key -t my-nextjs-app-image .
    docker build -t my-nextjs-app-image .
    ```
3.  Запустите контейнер из созданного образа, передав необходимые переменные окружения:
    ```bash
    docker run -d -p 3000:3000 \
      --env-file ./.env.production \ # Или передавайте переменные по одной: -e VAR_NAME=value
      --name my-nextjs-container \
      my-nextjs-app-image
    ```
    В этом случае Nginx будет проксировать запросы на порт 3000 вашего хоста, который Docker сопоставил с портом 3000 контейнера.

## 11. Защита ("чтобы скачать сайт просто так не могли")

-   **Серверный код**: Код, выполняющийся на сервере (API routes, Server Components), не доступен клиенту напрямую. Next.js компилирует его для серверного выполнения.
-   **Клиентский код**: Клиентский JavaScript-бандл загружается в браузер пользователя. Это необходимо для работы React-приложения. Отключение source maps (`productionBrowserSourceMaps: false`) затрудняет его анализ, но не предотвращает загрузку.
-   **Переменные окружения**: Храните секреты только на сервере в файле `.env.production`, который не должен быть доступен через веб-сервер и не должен быть в Git.
-   **Nginx**: Конфигурация Nginx должна предотвращать листинг директорий и прямой доступ к файлам, которые не предназначены для публичного доступа (например, `.next/server/` или `node_modules`). Пример `nginx.conf.example` учитывает это.
-   **Безопасность API**: Если вы создаете API эндпоинты, защищайте их аутентификацией и авторизацией.

## 12. Обновление приложения

Когда вы вносите изменения в код:
1.  Загрузите изменения на сервер (например, `git pull`).
2.  Установите новые зависимости, если есть (`npm install`).
3.  Пересоберите приложение (`npm run build`).
4.  Перезапустите приложение с помощью PM2 (`pm2 restart my-nextjs-app`) или пересоберите и перезапустите Docker-контейнер.

Это базовое руководство. В зависимости от ваших конкретных потребностей, могут потребоваться дополнительные настройки.
