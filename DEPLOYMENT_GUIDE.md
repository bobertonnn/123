
# Руководство по развертыванию на выделенном сервере

Это руководство поможет вам развернуть ваше Next.js приложение на выделенном сервере.

## 1. Предварительные требования

Убедитесь, что на вашем сервере установлены:
- **Node.js**: Рекомендуется последняя LTS-версия (например, 20.x). Вы можете установить его с помощью `nvm` (Node Version Manager).
- **npm** (обычно поставляется с Node.js) или другой менеджер пакетов, который вы используете (например, `pnpm`, `yarn`).
- **Git** (для клонирования репозитория).
- (Опционально, но рекомендуется) **Docker** и **Docker Compose**, если вы планируете использовать контейнеризацию.
- (Опционально, но рекомендуется) **MySQL сервер**, если вы переходите на него с `localStorage`.

## 2. Подготовка проекта на сервере

1.  **Клонируйте ваш репозиторий** (или скопируйте файлы проекта) на сервер:
    ```bash
    git clone <your-repository-url>
    cd <your-project-directory>
    ```

2.  **Установите зависимости:**
    ```bash
    npm install
    # или pnpm install / yarn install
    ```

## 3. Переменные окружения

Вашему приложению для корректной работы потребуются переменные окружения.

- В корне вашего проекта на сервере создайте файл `.env.production` из примера `db_schema/mysql/.env.production.example`:
  ```bash
  cp db_schema/mysql/.env.production.example .env.production
  ```
- Откройте `.env.production` в текстовом редакторе (например, `nano .env.production`) и **заполните все необходимые значения** вашими реальными данными:
    - `NEXT_PUBLIC_FIREBASE_*`: Ваши ключи Firebase.
    - `GOOGLE_API_KEY`: Ваш API ключ для Google AI Studio (используется Genkit на сервере). **Не добавляйте `NEXT_PUBLIC_` к этой переменной.**
    - `TELEGRAM_BOT_TOKEN` и `TELEGRAM_CHAT_ID`: Ваши данные для Telegram.
    - `DB_HOST`, `DB_USER`, `DB_PASSWORD`, `DB_NAME` (или `DATABASE_URL`): Данные для подключения к вашей MySQL базе данных.
- **Важно:** Никогда не добавляйте файл `.env.production` с реальными секретами в систему контроля версий (git). Убедитесь, что `.env.production` добавлен в ваш файл `.gitignore`.
- Next.js автоматически загрузит переменные из `.env.production` при сборке и запуске в продакшен-режиме.

## 4. База данных MySQL (если используется)

1.  **Установите и настройте MySQL сервер** на вашем выделенном сервере.
2.  **Создайте базу данных** и пользователя для вашего приложения.
3.  **Примените SQL-схемы**, предоставленные в папке `db_schema/mysql/`. Вы можете выполнить их, например, через MySQL CLI:
    ```bash
    mysql -u your_mysql_user -p your_database_name < db_schema/mysql/01_users.sql
    mysql -u your_mysql_user -p your_database_name < db_schema/mysql/02_contacts.sql
    mysql -u your_mysql_user -p your_database_name < db_schema/mysql/03_notifications.sql
    mysql -u your_mysql_user -p your_database_name < db_schema/mysql/04_documents.sql
    ```
4.  **Разработайте API эндпоинты** в вашем Next.js приложении для взаимодействия с этой базой данных и **обновите клиентскую логику** (например, в `src/lib/contactManager.ts`, `src/lib/notificationManager.ts`, `src/app/(app)/dashboard/page.tsx` и `src/components/documents/PdfUploader.tsx`) для использования этих API вместо `localStorage`. (См. комментарии-заглушки `TODO: [DB Integration]` в этих файлах).

## 5. Сборка приложения

Соберите ваше приложение для продакшена:
```bash
npm run build
```
Эта команда создаст оптимизированную сборку. Поскольку в `next.config.ts` добавлена опция `output: 'standalone'`, сборка будет находиться в папке `.next/standalone` и будет содержать только необходимые для запуска файлы, включая минимизированные `node_modules`. Это идеально для Docker.
По умолчанию, карты кода (source maps) для клиентского бандла не будут генерироваться (`productionBrowserSourceMaps: false` в `next.config.ts`), что является базовой мерой защиты.

## 6. Запуск приложения

Существует несколько способов запуска приложения в продакшене:

### 6.1. С использованием Node.js и PM2 (Менеджер процессов)

PM2 поможет вашему приложению работать в фоновом режиме, автоматически перезапускаться при сбоях и после перезагрузки сервера.

1.  **Установите PM2 глобально (если еще не установлен):**
    ```bash
    npm install pm2 -g
    ```

2.  **Настройте PM2 для вашего приложения.** Вы можете использовать пример `ecosystem.config.js.example`. Скопируйте его в `ecosystem.config.js` и настройте:
    ```bash
    cp ecosystem.config.js.example ecosystem.config.js
    # Отредактируйте ecosystem.config.js
    # ВАЖНО: Если вы используете 'output: standalone', то script в ecosystem.config.js должен указывать на .next/standalone/server.js
    # Пример для 'standalone':
    # script: './.next/standalone/server.js',
    # А если НЕ 'standalone', то что-то вроде:
    # script: 'node_modules/.bin/next',
    # args: 'start -p 3000', # Укажите нужный порт
    ```
    Запустите приложение с помощью PM2, указав окружение `production`:
    ```bash
    pm2 start ecosystem.config.js --env production
    ```
    *Примечание: PM2 автоматически загрузит переменные из `.env.production`, если они определены в `ecosystem.config.js` или если PM2 запускается в том же окружении, где доступен `.env.production`.*

3.  **Основные команды PM2:**
    -   `pm2 list`: Показать список всех запущенных приложений.
    -   `pm2 logs <app_name_or_id>`: Показать логи приложения.
    -   `pm2 startup`: Настроить PM2 для автоматического запуска ваших приложений при загрузке системы.
    -   `pm2 save`: Сохранить текущий список процессов PM2.

### 6.2. С использованием Docker

Если вы предпочитаете использовать Docker:
1.  Убедитесь, что Docker установлен на вашем сервере.
2.  Используйте предоставленный `Dockerfile` для сборки образа вашего приложения:
    ```bash
    docker build -t my-nextjs-app-image .
    ```
3.  Запустите контейнер из созданного образа, передав необходимые переменные окружения из вашего файла `.env.production`:
    ```bash
    docker run -d -p 3000:3000 \
      --env-file ./.env.production \ # Этот флаг передает все переменные из файла
      --name my-nextjs-container \
      my-nextjs-app-image
    ```
    Контейнер запустит приложение на порту 3000 внутри Docker. Вы можете сопоставить его с любым портом на хосте (например, `-p 8080:3000`).

## 7. Обратный прокси (Nginx)

Настоятельно рекомендуется использовать веб-сервер, такой как Nginx, в качестве обратного прокси. Nginx будет принимать HTTP/HTTPS запросы и перенаправлять их на ваше Next.js приложение.

1.  **Установите Nginx.**
2.  **Настройте Nginx для вашего сайта.** Создайте новый файл конфигурации. Вы можете использовать пример `nginx.conf.example` как основу. Замените `your-domain.com` на ваш домен, и `3000` на порт, на котором запущено ваше Next.js приложение (либо напрямую через PM2, либо порт хоста, сопоставленный с Docker-контейнером).
3.  **Создайте символическую ссылку** на ваш файл конфигурации в `sites-enabled`.
4.  **Проверьте конфигурацию Nginx** (`sudo nginx -t`) и **перезапустите Nginx**.
5.  **Настройка HTTPS (SSL с Let's Encrypt):** Используйте Certbot.

## 8. Брандмауэр

Убедитесь, что ваш брандмауэр (например, `ufw`) настроен на разрешение трафика на порты 80 (HTTP) и 443 (HTTPS).

## 9. Защита ("чтобы скачать сайт просто так не могли")

-   **Серверный код**: Код, выполняющийся на сервере (Server Components, Server Actions, API routes), не доступен клиенту напрямую.
-   **Клиентский код**: Клиентский JavaScript-бандл загружается в браузер. Отключение source maps (`productionBrowserSourceMaps: false`) затрудняет его анализ.
-   **Переменные окружения**: Храните секреты (`GOOGLE_API_KEY`, `TELEGRAM_BOT_TOKEN`, данные БД и т.д.) только на сервере в файле `.env.production`, который не должен быть доступен через веб-сервер и не должен быть в Git. `NEXT_PUBLIC_` переменные будут встроены в клиентский бандл.
-   **Nginx**: Конфигурация Nginx должна предотвращать листинг директорий и прямой доступ к файлам, которые не предназначены для публичного доступа (например, `.next/` кроме `static`, `node_modules`).
-   **`output: 'standalone'`**: Эта опция сборки Next.js помогает, так как в папку `.next/standalone` копируются только необходимые для запуска файлы, что уменьшает поверхность атаки и объем кода на сервере.

## 10. Обновление приложения

1.  Загрузите изменения на сервер (например, `git pull`).
2.  Установите новые зависимости, если есть (`npm install`).
3.  Пересоберите приложение (`npm run build`).
4.  Перезапустите приложение:
    -   **PM2**: `pm2 restart my-nextjs-app` (или имя из `ecosystem.config.js`).
    -   **Docker**: Пересоберите образ (`docker build ...`) и перезапустите контейнер (`docker stop ...`, `docker rm ...`, `docker run ...`).

Это базовое руководство. В зависимости от ваших конкретных потребностей, могут потребоваться дополнительные настройки.
